<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>AIå‹•ç‰©è¨ºæ–­</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="a.png" />
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      font-family: 'Zen Maru Gothic', sans-serif;
      background: linear-gradient(to bottom right, #ffe4ec, #ffffff);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      overflow-y: auto;
      padding: 20px 0;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      padding: 20px;
      width: 92%;
      max-width: 360px;
      text-align: center;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 15px;
      color: #ff69b4;
    }

    input, select {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 0.9rem;
    }

    .button {
      background: linear-gradient(to bottom right, #ff99cc, #ff66b2);
      color: white;
      padding: 12px;
      border: none;
      border-radius: 15px;
      box-shadow: 0 5px 15px rgba(255,105,180,0.4);
      font-size: 1rem;
      font-weight: bold;
      margin-top: 10px;
      cursor: pointer;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .emoji-list {
      font-size: 1.5rem;
      margin-top: 10px;
      line-height: 1.8;
    }

    img.preview {
      max-width: 100%;
      margin-top: 10px;
      border-radius: 10px;
    }

    video {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }

    .warning-text {
      color: red;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .status-icon {
      font-size: 1.5rem;
      margin-bottom: 5px;
      user-select: none;
      display: none;
    }

    .popup-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      display: none;
    }

    .popup-box {
      background: white;
      border-radius: 20px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .popup-box p {
      margin-bottom: 20px;
      font-size: 1rem;
    }

    .popup-box button {
      background: #ff66b2;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }

    .emoji-title {
      font-weight: bold;
      font-size: 1rem;
      margin-top: 20px;
      color: #ff69b4;
    }

    .sample-title-ok {
      color: green;
      font-weight: bold;
      margin: 5px 0;
      font-size: 0.95rem;
    }

    .sample-title-ng {
      color: red;
      font-weight: bold;
      margin: 5px 0;
      font-size: 0.95rem;
    }

    .sample-images {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      margin-bottom: 10px;
    }

    .sample-images img {
      width: 150px;
      height: 225px;
      object-fit: cover;
      border-radius: 10px;
    }

    .sns-label {
      font-size: 0.85rem;
      color: #666;
      margin-top: 10px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>è¨ºæ–­æº–å‚™ç”»é¢ï¼</h1>

    <input type="text" id="nickname" maxlength="20" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ï¼ˆ20æ–‡å­—ä»¥å†…ï¼‰" required />
    <select id="gender" required>
      <option value="">æ€§åˆ¥ã‚’é¸æŠ</option>
      <option value="male">ç”·</option>
      <option value="female">å¥³</option>
    </select>
    <select id="age" required></select>
    <select id="prefecture" required>
      <option value="">ä½ã‚“ã§ã„ã‚‹çœŒã‚’é¸æŠ</option>
      <option>åŒ—æµ·é“</option><option>é’æ£®çœŒ</option><option>å²©æ‰‹çœŒ</option><option>å®®åŸçœŒ</option>
      <option>ç§‹ç”°çœŒ</option><option>å±±å½¢çœŒ</option><option>ç¦å³¶çœŒ</option><option>èŒ¨åŸçœŒ</option>
      <option>æ ƒæœ¨çœŒ</option><option>ç¾¤é¦¬çœŒ</option><option>åŸ¼ç‰çœŒ</option><option>åƒè‘‰çœŒ</option>
      <option>æ±äº¬éƒ½</option><option>ç¥å¥ˆå·çœŒ</option><option>æ–°æ½ŸçœŒ</option><option>å¯Œå±±çœŒ</option>
      <option>çŸ³å·çœŒ</option><option>ç¦äº•çœŒ</option><option>å±±æ¢¨çœŒ</option><option>é•·é‡çœŒ</option>
      <option>å²é˜œçœŒ</option><option>é™å²¡çœŒ</option><option>æ„›çŸ¥çœŒ</option><option>ä¸‰é‡çœŒ</option>
      <option>æ»‹è³€çœŒ</option><option>äº¬éƒ½åºœ</option><option>å¤§é˜ªåºœ</option><option>å…µåº«çœŒ</option>
      <option>å¥ˆè‰¯çœŒ</option><option>å’Œæ­Œå±±çœŒ</option><option>é³¥å–çœŒ</option><option>å³¶æ ¹çœŒ</option>
      <option>å²¡å±±çœŒ</option><option>åºƒå³¶çœŒ</option><option>å±±å£çœŒ</option><option>å¾³å³¶çœŒ</option>
      <option>é¦™å·çœŒ</option><option>æ„›åª›çœŒ</option><option>é«˜çŸ¥çœŒ</option><option>ç¦å²¡çœŒ</option>
      <option>ä½è³€çœŒ</option><option>é•·å´çœŒ</option><option>ç†Šæœ¬çœŒ</option><option>å¤§åˆ†çœŒ</option>
      <option>å®®å´çœŒ</option><option>é¹¿å…å³¶çœŒ</option><option>æ²–ç¸„çœŒ</option>
    </select>
    <div style="font-size: 0.69rem; color: #000000; margin-top: 10px;">
      ãƒ•ã‚©ãƒ­ãƒã—ã¦ã»ã—ã„ã€snsã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆã¯æ•™ãˆã¦ãã ã•ã„ã€‚<br>
      ãªã„å ´åˆã¯ç‰¹ã«ç„¡ã—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
    </div>
    <select id="snsType" required>
      <option value="">SNSã‚’é¸æŠ</option>
      <option value="Instagram">Instagram</option>
      <option value="TikTok">TikTok</option>
      <option value="ç‰¹ã«ãªã—">ç‰¹ã«ãªã—</option>
    </select>
    <input type="text" id="snsAccount" placeholder="ç‰¹ã«ãªã„å ´åˆã¯ã€ç‰¹ã«ãªã—ã¨è¨˜å…¥ã—ã¦ãã ã•ã„ã€‚" required />

    <button class="button" onclick="openCamera()">ğŸ“¸ ã‚«ãƒ¡ãƒ©ã§å†™çœŸã‚’æ’®ã‚‹</button>
    <video id="cameraPreview" autoplay playsinline style="display:none;"></video>
    <canvas id="cameraCanvas" style="display:none;"></canvas>
    <img id="preview" class="preview" src="#" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="display:none;" />
    <button id="captureBtn" class="button" style="display:none;" onclick="capturePhoto()">ğŸ“· æ’®å½±ã—ã¦ç¢ºå®š</button>

    <div class="emoji-title">è¨ºæ–­ã•ã‚Œã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹å‹•ç‰©</div>
    <div class="emoji-list">ğŸµğŸ¦ğŸ¶ğŸºğŸ¦ŠğŸ¦ğŸ±ğŸ¦ğŸ¯ğŸ´<br>ğŸ®ğŸ·ğŸ—ğŸğŸ¦’ğŸ˜ğŸ¦ğŸ¦›ğŸ­ğŸ¹<br>ğŸ¦«ğŸ¦”ğŸ¦‡ğŸ»ğŸ»â€â„ï¸ğŸ¨ğŸ°ğŸ¿ï¸ğŸ¦„ğŸ¦“</div>
    <div id="iconBox" class="status-icon">âŒ</div>
    <div id="uploadWarning" class="warning-text" style="display: none;">
      ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã§ã™ï¼ãƒãƒ„å°ãŒæ¶ˆãˆã¦ã‹ã‚‰ã€è¨ºæ–­é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼
    </div>
    <button class="button" id="startButton" onclick="startDiagnosis()" disabled>è¨ºæ–­é–‹å§‹</button>

    <div style="font-size: 0.75rem; color: #777; margin-top: 10px;">
      è¨ºæ–­ã‚’é–‹å§‹ã—ãŸã‚‰ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¨åˆ©ç”¨è¦ç´„ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã—ã¾ã™ã€‚
    </div>
    <button onclick="location.href='step1.html'" style="margin-top: 8px; font-size: 0.8rem; background: none; border: none; color: #007BFF; text-decoration: underline; cursor: pointer;">
      ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¨åˆ©ç”¨è¦ç´„
    </button>
  </div>

  <div id="popup" class="popup-overlay">
    <div class="popup-box">
      <p>ç”»åƒã‚µã‚¤ã‚ºã‚’åœ§ç¸®ã—ã¾ã™ï¼<br>è¨ºæ–­ã«ã¯å½±éŸ¿ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
      <button onclick="closePopup()">OK</button>
    </div>
  </div>

<script>
  const ageSelect = document.getElementById('age');
  for(let i=0; i<=100; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = i + 'æ­³';
    ageSelect.appendChild(opt);
  }

  const preview = document.getElementById('preview');
  const startButton = document.getElementById('startButton');
  const iconBox = document.getElementById('iconBox');
  const uploadWarning = document.getElementById('uploadWarning');
  const popup = document.getElementById('popup');

  const cloudName = "dywhxia8m";
  const uploadPreset = "mi_default";
  let uploadedImageUrl = "";
  let isUploading = false;
  let stream;

  function closePopup() {
    popup.style.display = "none";
  }

  async function openCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });
      document.getElementById("cameraPreview").srcObject = stream;
      document.getElementById("cameraPreview").style.display = "block";
      document.getElementById("captureBtn").style.display = "inline-block";
    } catch (error) {
      alert("ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
    }
  }

  async function capturePhoto() {
    const video = document.getElementById("cameraPreview");
    const canvas = document.getElementById("cameraCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/jpeg", 0.9));
    const imageUrl = URL.createObjectURL(blob);
    preview.src = imageUrl;
    preview.style.display = "block";

    stream.getTracks().forEach(track => track.stop());
    document.getElementById("cameraPreview").style.display = "none";
    document.getElementById("captureBtn").style.display = "none";

    const file = new File([blob], "captured.jpg", { type: "image/jpeg" });

    startButton.disabled = true;
    iconBox.style.display = "block";
    iconBox.textContent = "âŒ";
    uploadWarning.style.display = "block";
    isUploading = true;

    if (file.size > 1024 * 1024) {
      popup.style.display = "flex";
      const compressed = await compressImage(file, 0.8);
      await uploadToCloudinary(compressed);
    } else {
      await uploadToCloudinary(file);
    }

    if (uploadedImageUrl) {
      startButton.disabled = false;
      iconBox.style.display = "none";
      uploadWarning.style.display = "none";
      isUploading = false;
    }
  }

  function compressImage(file, quality) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.readAsDataURL(file);
      reader.onload = (e) => {
        const img = new Image();
        img.src = e.target.result;
        img.onload = () => {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          canvas.toBlob((blob) => {
            resolve(new File([blob], file.name, { type: blob.type }));
          }, "image/jpeg", quality);
        };
      };
    });
  }

  async function uploadToCloudinary(file) {
    const nickname = document.getElementById('nickname').value.trim();
    const gender = document.getElementById('gender').value;
    const age = document.getElementById('age').value;
    const prefecture = document.getElementById('prefecture').value;
    const snsType = document.getElementById('snsType').value;
    const snsAccount = document.getElementById('snsAccount').value.trim();

    const folderName = gender === "male" ? "ç”·" : "å¥³";

    const url = `https://api.cloudinary.com/v1_1/${cloudName}/upload`;
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", uploadPreset);
    formData.append("folder", folderName);
    formData.append("tags", `ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ :${nickname},æ€§åˆ¥:${gender},å¹´é½¢:${age},éƒ½é“åºœçœŒ:${prefecture},SNS:${snsType},ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ:${snsAccount}`);

    try {
      const res = await fetch(url, { method: "POST", body: formData });
      const data = await res.json();
      uploadedImageUrl = data.secure_url;
    } catch (err) {
      console.error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—:", err);
      alert("ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
    }
  }

  function startDiagnosis() {
    const nickname = document.getElementById('nickname').value.trim();
    const gender = document.getElementById('gender').value;
    const age = document.getElementById('age').value;
    const prefecture = document.getElementById('prefecture').value;
    const snsType = document.getElementById('snsType').value;
    const snsAccount = document.getElementById('snsAccount').value.trim();

    if (!nickname || !gender || !age || !prefecture || !snsType || !snsAccount || !uploadedImageUrl || isUploading) {
      alert("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ãƒ»é¸æŠãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼");
      return;
    }

    localStorage.setItem("nickname", nickname);
    localStorage.setItem("gender", gender);
    localStorage.setItem("age", age);
    localStorage.setItem("prefecture", prefecture);
    localStorage.setItem("snsType", snsType);
    localStorage.setItem("snsAccount", snsAccount);
    localStorage.setItem("uploadedImageUrl", uploadedImageUrl);

    window.location.href = "step3.html";
  }
</script>
</body>
</html>
